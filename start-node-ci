#!/usr/bin/env bash
set -e

PROFILE_ARGS=()
SERVICES=(cli gatekeeper keymaster redis mongodb)

if [ -f .env ]; then
  set -a
  # shellcheck disable=SC1091
  . ./.env
  set +a
fi

if [ "${KC_IPFS_ENABLE,,}" != "false" ]; then
  PROFILE_ARGS=(--profile ipfs)
  SERVICES=(ipfs "${SERVICES[@]}")
fi

docker compose --profile ipfs down
docker compose down
docker compose "${PROFILE_ARGS[@]}" build "${SERVICES[@]}"
docker compose "${PROFILE_ARGS[@]}" up -d "${SERVICES[@]}"

echo "Waiting for all services to be 'Up'..."

MAX_RETRIES=30
RETRY_INTERVAL=5
RETRY_COUNT=0

while true; do
  TOTAL_SERVICES="${#SERVICES[@]}"
  UP_COUNT=$(docker compose "${PROFILE_ARGS[@]}" ps --services --status running | wc -l)

  if [[ "$UP_COUNT" -eq "$TOTAL_SERVICES" ]]; then
    echo "✅ All containers are 'Up'"
    break
  fi

  if [[ "$RETRY_COUNT" -ge "$MAX_RETRIES" ]]; then
    echo "❌ Timed out waiting for containers to be 'Up'"
    docker compose ps
    exit 1
  fi

  echo "⏳ Waiting... ($RETRY_COUNT/$MAX_RETRIES) running ${UP_COUNT}/${TOTAL_SERVICES}"
  sleep "$RETRY_INTERVAL"
  ((RETRY_COUNT++))
done
