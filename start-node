#!/usr/bin/env bash
set -e

PROFILE_ARGS=()
SERVICES=("$@")

if [ -f .env ]; then
    set -a
    # shellcheck disable=SC1091
    . ./.env
    set +a
fi

KC_IPFS_ENABLE_LC="$(printf '%s' "${KC_IPFS_ENABLE:-}" | tr '[:upper:]' '[:lower:]')"

if [ "$KC_IPFS_ENABLE_LC" != "false" ]; then
    PROFILE_ARGS=(--profile ipfs)
fi

if [ ${#SERVICES[@]} -gt 0 ] && [ "$KC_IPFS_ENABLE_LC" != "false" ]; then
    if ! printf '%s\n' "${SERVICES[@]}" | grep -qx "ipfs"; then
        SERVICES=("ipfs" "${SERVICES[@]}")
    fi
fi

docker compose --profile ipfs down
docker compose down
docker compose "${PROFILE_ARGS[@]}" build "${SERVICES[@]}"
docker compose "${PROFILE_ARGS[@]}" up "${SERVICES[@]}"
